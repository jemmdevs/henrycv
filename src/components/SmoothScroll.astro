---
// Lenis Smooth Scroll Component - Optimized for maximum performance
// Place just before </body> in Layout
---

<script>
  import Lenis from "lenis";
  import {
    MOBILE_BREAKPOINT,
    RESIZE_DEBOUNCE_MS,
    LENIS_CONFIG,
  } from "../utils/constants";

  let lenis: Lenis | null = null;
  let rafId: number | null = null;
  let isInitialized = false;

  function isMobile(): boolean {
    return window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT}px)`).matches;
  }

  function cleanup(): void {
    if (lenis) {
      lenis.destroy();
      lenis = null;
      (window as any).lenis = null;
    }
    if (rafId) {
      cancelAnimationFrame(rafId);
      rafId = null;
    }
    isInitialized = false;
  }

  function initLenis(): void {
    // Cleanup previous instance
    cleanup();

    // Skip on mobile for native scroll performance
    if (isMobile()) {
      return;
    }

    // Check for reduced motion preference
    if (window.matchMedia("(prefers-reduced-motion: reduce)").matches) {
      return;
    }

    lenis = new Lenis({
      lerp: LENIS_CONFIG.LERP,
      wheelMultiplier: LENIS_CONFIG.WHEEL_MULTIPLIER,
      touchMultiplier: LENIS_CONFIG.TOUCH_MULTIPLIER,
      infinite: false,
      orientation: "vertical",
      gestureOrientation: "vertical",
      smoothWheel: true,
      syncTouch: false,
      syncTouchLerp: LENIS_CONFIG.LERP,
    });

    function raf(time: number): void {
      lenis?.raf(time);
      rafId = requestAnimationFrame(raf);
    }

    rafId = requestAnimationFrame(raf);
    isInitialized = true;

    // Expose globally for debugging
    (window as any).lenis = lenis;
  }

  // Initial setup
  initLenis();

  // Astro View Transitions support
  document.addEventListener("astro:page-load", () => {
    // Only reinitialize if not already initialized
    if (!isInitialized) {
      initLenis();
    }
  });

  // Cleanup before page transition
  document.addEventListener("astro:before-preparation", cleanup);

  // Pause when tab is not visible
  document.addEventListener("visibilitychange", () => {
    if (!lenis) return;

    if (document.hidden) {
      lenis.stop();
    } else {
      lenis.start();
    }
  });

  // Handle resize with debounce
  let resizeTimeout: ReturnType<typeof setTimeout>;
  let wasMobile = isMobile();

  window.addEventListener(
    "resize",
    () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        const nowMobile = isMobile();

        if (wasMobile !== nowMobile) {
          wasMobile = nowMobile;
          initLenis();
        } else if (lenis) {
          lenis.resize();
        }
      }, RESIZE_DEBOUNCE_MS);
    },
    { passive: true }
  );
</script>

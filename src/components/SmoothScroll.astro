---
// Componente para Lenis Smooth Scroll - Optimizado para máximo rendimiento
// Se coloca justo antes del cierre del </body> en el Layout
---

<script>
    import Lenis from "lenis";

    let lenis: Lenis | null = null;
    let rafId: number | null = null;

    // Detectar si es un dispositivo móvil
    function isMobile(): boolean {
        return window.matchMedia("(max-width: 768px)").matches;
    }

    // Configuración optimizada de Lenis
    function initLenis() {
        // Destruir instancia anterior si existe
        if (lenis) {
            lenis.destroy();
            lenis = null;
        }
        if (rafId) {
            cancelAnimationFrame(rafId);
            rafId = null;
        }

        // Solo inicializar Lenis en desktop (mejor rendimiento en móvil con scroll nativo)
        if (isMobile()) {
            return;
        }

        lenis = new Lenis({
            lerp: 0.1, // Lerp optimizado para mejor sincronización visual
            wheelMultiplier: 0.8, // Multiplicador reducido para scroll más controlado
            touchMultiplier: 1.5, // Mejor respuesta táctil en móviles
            infinite: false, // Desactivar scroll infinito
            orientation: "vertical", // Optimizar solo para vertical
            gestureOrientation: "vertical",
            smoothWheel: true, // Activar suavizado de rueda
            syncTouch: false, // No sincronizar touch (mejor rendimiento en móviles)
            syncTouchLerp: 0.1, // Lerp para touch sincronizado con el principal
        });

        // RAF optimizado con tiempo de alta resolución
        function raf(time: number) {
            lenis?.raf(time);
            rafId = requestAnimationFrame(raf);
        }

        rafId = requestAnimationFrame(raf);

        // Exponer lenis globalmente para debugging y sincronización con otras librerías
        (window as any).lenis = lenis;
    }

    // Inicializar inmediatamente
    initLenis();

    // Soporte para Astro View Transitions - reiniciar Lenis después de navegación
    document.addEventListener("astro:page-load", () => {
        initLenis();
    });

    // Limpiar al cambiar de página (antes de la transición)
    document.addEventListener("astro:before-preparation", () => {
        if (lenis) {
            lenis.destroy();
            lenis = null;
        }
        if (rafId) {
            cancelAnimationFrame(rafId);
            rafId = null;
        }
    });

    // Pausar Lenis cuando la pestaña no está visible (ahorro de recursos)
    // Solo en desktop donde Lenis está activo
    document.addEventListener("visibilitychange", () => {
        if (!lenis) return;

        if (document.hidden) {
            lenis.stop();
        } else {
            lenis.start();
        }
    });

    // Manejar resize con debounce para mejor rendimiento
    let resizeTimeout: ReturnType<typeof setTimeout>;
    let wasMobile = isMobile();

    window.addEventListener(
        "resize",
        () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                const nowMobile = isMobile();

                // Si cambió de móvil a desktop o viceversa, reiniciar Lenis
                if (wasMobile !== nowMobile) {
                    wasMobile = nowMobile;
                    initLenis();
                } else {
                    // Solo resize si sigue siendo desktop
                    lenis?.resize();
                }
            }, 150);
        },
        { passive: true },
    );
</script>
